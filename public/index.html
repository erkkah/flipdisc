<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<title>FlipDisc controller</title>

	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>

	<link rel="stylesheet" href="uikit/css/uikit.gradient.css" />
	<script src="uikit/js/uikit.js"></script>

	<link rel="stylesheet" href="uikit/css/components/sortable.gradient.css" />
	<script src="uikit/js/components/sortable.js"></script>

	<link rel="stylesheet" href="uikit/css/components/notify.gradient.css" />
	<script src="uikit/js/components/notify.js"></script>
</head>
<body>
	<nav class="uk-navbar">
		<a href="" class="uk-navbar-brand">FlipDisc</a>
		<ul class="uk-navbar-nav" data-uk-switcher="{connect:'#display_views'}">
			<li><a href=""><i class="uk-icon-tv"></i> Live</a></li>
			<li><a href=""><i class="uk-icon-files-o"></i> Scripts</a></li>
			<li><a href=""><i class="uk-icon-cogs"></i> Setup</a></li>
		</ul>
	</nav>
	<div data-uk-observe class="uk-container uk-container-center uk-margin-top uk-margin-large-bottom">
		<div>
			<ul id="display_views" class="uk-switcher uk-margin">
				<li>
					<!-- Live -->
					<div class="uk-grid">
						<liveview class="uk-width-1-1"></liveview>
					</div>
					<div class="uk-grid">
						<modeselector class="uk-width-1-1"></modeselector>
					</div>
				</li>
				<li>
					<!-- Scripts -->
					<ul class="uk-tab" data-uk-tab="{connect:'#script-tabs'}">
						<li class="uk-active"><a href="">Modes</a></li>
						<li><a href="">Display scripts</a></li>
						<li><a href="">Data scripts</a></li>
					</ul>

					<ul class="uk-switcher uk-margin uk-height-1-1" id="script-tabs">
						<li>
							<modeeditor>
								Each <strong>Display Mode</strong> is a list of display script references.
								Each display script reference have separate configurations as simple json documents
								that is used to set up each display script before animation starts.
							</modeeditor>
						</li>
						<li>
							<scripteditor id="dsp-scripteditor">
								<strong>Display scripts</strong> do all the dot flipping on the display.<br/>
								All scripts must define a variable <q>code</q> holding the class that is used to draw.
								The class must define <q>onSetup(configuration, dataSource)</q> and
								<q>onFrame(oldFrame, timePassedInSeconds, frameCallback)</q> methods.
								The <q>onSetup</q> method is called when animation starts, followed
								by repeated calls to <q>onFrame</q>.
								The configuration parameter is the passed from the display mode json config, and the 
								dataSource holds all data defined by data scripts.
								Calling the provided <q>frameCallback(updatedFrame, milliSecondsToNextFrame)</q>
								from <q>onFrame</q> updates the display and retriggers another call if
								milliSecondsToNextFrame is non-zero.
							</scripteditor>
						</li>
						<li>
							<scripteditor id="data-scripteditor">
								<strong>Data scripts</strong> define the data that display scripts can use to update the display.
								All scripts must define a variable <q>code</q> holding the class that is called to generate data.
								The class must define a method <q>onUpdate</q> that returns the updated data.
								The data returned is stored in the data source storage using the data script name as a key.
								The data source storage is passed as the second argument to the display script <q>onSetup</q> method.
							</scripteditor>
						</li>
					</ul>
				</li>
				<li>
					<!-- Setup -->
					<div class="uk-grid">
						<setup class="uk-width-1-1"></setup>
					</div>
				</li>
			</ul>
		</div>
	</div>

	<script src="/socket.io/socket.io.js"></script>
	<script>
		var socket = io();
	</script>

	<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.2.2/ace.js"/></script>

	<script src="https://cdn.jsdelivr.net/riot/2.3/riot+compiler.min.js"></script>
	<script src="liveview.js" type="riot/tag"></script>
	<script src="modeselector.js" type="riot/tag"></script>
	<script src="modeeditor.js" type="riot/tag"></script>
	<script src="scripteditor.js" type="riot/tag"></script>
	<script src="setup.js" type="riot/tag"></script>
	<script>
		riot.compile(function() {
			riot.mount('liveview, modeselector, modeeditor, setup', socket);
			var scriptEditor = riot.mount('#dsp-scripteditor', {
				"socket": socket,
				"title": "Display scripts",
				"events": {
					"update": "scriptschanged",
					"set": "setscript",
					"delete": "deletescript"
				},
				"template": '"use strict";\nvar code = class {\n' + 
				'	onSetup(configuration, dataSource){\n' +
				'		// set properties of this animation script\n' +
 				'		// pull data from data source\n' +
 				'		// set up animation\n' +
 				'	}\n' +
 				'	onFrame(oldFrame, timePassedInSeconds, frameCallback){\n' +
				'		// calculate one frame of animation\n' +
				'		// ...\n' +
				'		// call frameCallback with updated frame data and ms to next callback\n' +
				'		// Providing no callback time ends the script.\n' +
				'		//\n' +
				'		// frameCallback(updatedFrame, 1000);\n' +
				' 	}\n' +
				'};\n'
			});
			var dataEditor = riot.mount('#data-scripteditor', {
				"socket": socket,
				"title": "Data scripts",
				"events": {
					"update": "datascriptschanged",
					"set": "setdatascript",
					"delete": "deletedatascript"
				},
				"template": '"use strict";\nvar code = class {\n' + 
				'	constructor(){\n' +
				'		// set up stuff\n' +
 				'	}\n' +
 				'	onUpdate(){\n' +
				'		// get fresh data\n' +
				'		// ...\n' +
				'		// return data object\n' +
				' 	}\n' +
				'};\n'
			});

		});
	</script>

	<script>
		socket.on('notification', function(message){
			UIkit.notify(message);
		});

		function stickyNotify(message){
			var div = $('#coms-dialog');
			if(div.length == 0){
				UIkit.notify('<div id="coms-dialog"></div>', {timeout: 0});
				div = $('#coms-dialog');
			}
			div.html(message);
		}

		socket.on('disconnect', function(){
			stickyNotify("<i class='uk-icon-bolt'></i> Disconnected from server");
		});

		socket.on('reconnecting', function(attempt){
			stickyNotify("<i class='uk-icon-spin uk-icon-spinner'></i> Reconnecting... " + attempt);
		})

		socket.on('reconnect', function(attempt){
			stickyNotify("<i class='uk-icon-heartbeat'></i> Reestablished server connection!");
			socket.emit('refresh');
		})

		// Hacketi-hack. Letting things settle before requesting refresh.
		setTimeout(function(){
			socket.emit('refresh');
		}, 100);
		
	</script>

</body>
</html>
